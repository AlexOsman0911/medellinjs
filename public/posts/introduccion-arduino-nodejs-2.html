<!DOCTYPE html><!--[if lt IE 7 ]>
<html class="ie ie6" lang="en">

<![endif]--><!--[if IE 7 ]>
<html class="ie ie7" lang="en">

<![endif]--><!--[if IE 8 ]>
<html class="ie ie8" lang="en">

<![endif]--><!--[if (gte IE 9)|!(IE)]>
<!-->
<html lang="es_CO">

<!--<![endif]-->

<head>
  <meta charset="UTF-8">
  <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport">
  <title>MedellinJS</title>
  <link href="/css/bootstrap.min.css" media="screen" rel="stylesheet" type="text/css">
  <link href="/css/font-awesome.min.css" media="screen" rel="stylesheet" type="text/css">
  <link href="/css/icomoon.css" media="screen" rel="stylesheet" type="text/css">
  <link href="/css/haze-buttons.css" media="screen" rel="stylesheet" type="text/css">
  <link href="/css/menu.css" media="screen" rel="stylesheet" type="text/css">
  <link href="/css/prism.css" media="screen" rel="stylesheet" type="text/css">
  <link href="/css/haze.css" media="screen" rel="stylesheet" type="text/css">
  <link rel="alternate" type="application/rss+xml"  href="/feed.xml" title="MedellinJS">
</head>

<body>

  <div class="top-menu">
  <a href="/">
    <div class="logo">
      MED.JS
    </div>
  </a>
  <div id="navigation-button">
    <i class="fa fa-bars fa-fw"></i>
  </div>
  <ul class="nav drop-down">
    <li><a href="/#eventos">Eventos</a></li>
    <li><a href="/posts">Art&iacute;culos</a></li>
    <li><a href="/charla">Comparte</a></li>
    <li><a href="/acerca">Acerca</a></li>
  </ul>
</div>

  
  

  
<section id="post">
  <div class="fullwidth-section">
    <div class="container">
      <div class="row">
        <div class="col-md-12">
          <h2 class="kill-top-margin"><strong>Introducción a Arduino y Node.js - HTTP - Parte 2</strong></h2>
          <div class="post-info color-primary-dark">
            <i class="fa fa-clock-o"></i> Agosto, 7, 2014
            <i class="im-user"></i> <a href="https://github.com/julianduque" target="_new">Julián Duque</a>
          </div>
          <p>
            <p><em>A continuación presentamos el segundo artículo de la serie <strong>Introducción a Arduino y Node.js</strong>, 
el primero lo pueden leer en: <a href="http://medellinjs.org/posts/introduccion-arduino-nodejs-1">Introducción a Arduino y Node.js - Serial - Parte 1</a></em></p>
<p>En el artículo anterior dimos una introducción a la programación de Arduino y Node.js 
en el cual realizamos una comunicación entre dos aplicaciones, una se ejecutaba en el Arduino (C++) y la 
otra corría en el computador con Node.js, la comunicación se estableció a través del puerto serial (USB). </p>
<p>En este nuevo artículo aprenderemos a realizar esta comunicación utilizando el protocolo HTTP.
<!-- more --></p>
<p>Para este caso vamos a reutilizar el montaje del Sensor de Temperatura que utilizamos
en el artículo anterior.</p>
<h3>Sensor de Temperatura</h3>
<p><strong>Componentes necesarios</strong></p>
<ul>
<li>1 Arduino UNO/Leonardo (o compatible) con cable USB</li>
<li>1 Shield Wifi o Ethernet con su respectivo cable</li>
<li>1 Sensor de temperatura LM35</li>
<li>1 LED Rojo</li>
<li>1 LED Verde</li>
<li>2 resistencias de 220 Ohms</li>
<li>Breadboard</li>
<li>Cables</li>
</ul>
<h4>Montaje</h4>
<p><img src="http://i.imgur.com/q7AcLuh.png?1" alt="Montaje"></p>
<h2>Comunicación HTTP Arduino &lt;&gt; Node.js</h2>
<p>El objetivo principal es crear un servidor <code>http</code> en Node.js el cual recibirá una petición
para validar si la temperatura supera un límite establecido y así tomar la decisión de encender
el LED Verde o el LED Rojo.</p>
<h3>Servidor HTTP en Node.js</h3>
<p>A continuación aprenderemos a crear un Servidor <code>http</code> básico utilizando Node.js.</p>
<p>El servidor responderá a una URL <code>/temp</code> la cual recibirá un parametro llamado <code>value</code> 
que contendrá el valor de temperatura retornado por el sensor. </p>
<p>El valor será comparado con el límite superior llamado <code>TEMP_LIMIT</code> y retornará <code>|warning|</code>
si este valor es superado o <code>|normal|</code> en caso contrario.</p>
<h4>server.js</h4>
<pre><code class="language-javascript">var http = require(&#39;http&#39;);
var url = require(&#39;url&#39;);

var TEMP_LIMIT = 28;

// Definimos el servidor HTTP
// La función interna es conocida como `request handler`, y es ejecutada
// cada vez que una peticion `http` llega al servidor
var server = http.createServer(function (req, res) {
  // Obtenemos la `url` solicitada por el cliente, esta `url` contiene
  // los parámetros de la petición, luego necesitamos analizar (parsear) su contenido
  var endpoint = req.url;

  // Verificamos si la URL contiene la ruta `/temp`
  if (endpoint.indexOf(&#39;/temp&#39;) !== -1) {
    // Analizamos la URL para extraer su contenido
    var parsedUrl = url.parse(endpoint, true);

    // Obtenemos el objeto que contiene los parámetros
    var params = parsedUrl.query || {};

    // Obtenemos la temperatura o `null` si no tenemos ningún valor
    var temp = params.value || null;

    // Realizamos la validación de temperatura y retornamos el resultado al cliente
    if (temp) {

      if (temp &gt; TEMP_LIMIT) {
        res.write(&#39;|warning|&#39;);
      } else {
        res.write(&#39;|normal|&#39;);
      }

    } else {
      res.write(&#39;Wrong param, please use `value`&#39;);
    }

  } else {
    res.write(&#39;Wrong endpoint, please use `/temp`&#39;);
  }

  res.end();
});

// Ejecutamos nuestro servidor en el puerto 8080
server.listen(8080);</code></pre>
<p>Para correr el servidor debemos ejecutar:</p>
<pre><code>$ node server.js</code></pre>
<p>Las peticiones <code>http</code> locales las podremos realizar a la ruta <code>http://localhost:8080</code></p>
<pre><code>$ curl http://localhost:8080/temp?value=22
|normal|

$ curl http://localhost:8080/temp?value=29
|warning|</code></pre>
<p>Los caracteres <code>|</code> los utilizaremos para delimitar el mensaje que necesitamos en el Arduino.</p>
<p>Ya nuestro servidor Node.js está listo para recibir peticiones desde el Arduino, a continuación
aprenderemos a conectar nuestro Arduino a la red y así poder realizar una petición HTTP.</p>
<h3>Cliente Arduino</h3>
<p>Para el cliente haremos algunas modificaciones al código del primer artículo, en este caso
cada 5 segundos realizaremos una petición <code>GET</code> al servidor Node.js y luego tomaremos
la decisión.</p>
<h4>client.ino</h4>
<pre><code class="language-c">// Incluimos las librerias necesarias para trabajar con el Ethernet Shield
// Si estas usando el Wifi Shield debes incluir &lt;WiFi.h&gt; en lugar de &lt;Ethernet.h&gt;
// Mas información en http://arduino.cc/en/Guide/ArduinoWiFiShield
#include &lt;Ethernet.h&gt;
#include &lt;SPI.h&gt;

#define LED_RED 7 // Definimos el pin del LED rojo
#define LED_GREEN 8 // Definimos el pin del LED verde
#define TEMP_SENSOR 0 // Definimos el pin analogo del sensor

// Definimos la MAC Address de nuestro Ethernet Shield
byte mac[] = {0x90, 0xA2, 0xDA, 0x0E, 0x98, 0x91};

// Definimos la Dirección IP del Servidor Node.js
byte server[] = {192, 168, 169, 100};

// Definimos la Dirección IP del Arduino
byte ip[] = {192, 168, 169, 120};

// Instanciamos el cliente Ethernet con el que nos conectaremos al servidor
EthernetClient client;

// Definimos la variable donde almacenaremos la respuesta del servidor.
String response = String(10);
// Definimos el separador del mensaje
char separator = &#39;|&#39;;
// Utilizaremos esta variable para verificar si la lectura de la respuesta ha comenzado
boolean started = false;

void setup() {
  Ethernet.begin(mac, ip); // Iniciamos el Ethernet Shield
  Serial.begin(9600); // Utilizaremos el puerto Serial como debug

  pinMode(LED_RED, OUTPUT); // Definimos el pin del LED rojo como salida
  pinMode(LED_GREEN, OUTPUT); // Definimos el pin del LED verde como salida
}

void loop() {
  // Utilizamos la misma lógica de lectura del sensor vista en el artículo
  // anterior.
  int voltage = analogRead(TEMP_SENSOR);
  int temp = (5 * voltage * 100) / 1024;

  // Realizamos la conexión al servidor Node.js en el puerto 8080
  if (client.connect(server, 8080)) {
    // Enviamos la peticion GET utilizando el protocolo HTTP
    client.println(&quot;GET /temp?value=&quot; + String(temp) + &quot; HTTP/1.0&quot;);
    client.println();

    // A continuación realizaremos la lectura de la respuesta desde el servidor
    // En este caso solo vamos a hacer lectura mientras estemos conectados
    // Luego de leer la respuesta completa desconectamos el cliente
    while (client.connected()) {
      // Solo realizaremos la lectura de la respuesta si el cliente tiene
      // algo para nosotros
      if (client.available()) {
        // Debemos leer caracter por caracter
        char c = client.read();

        // En el siguiente bloque de código utilizaremos el separador `|` para
        // verificar cuando empieza y termina el mensaje que necesitamos
        if (c != separator &amp;&amp; started) {
          response += c;
        } else if (c == separator &amp;&amp; !started) {
          started = true;
        } else if (c == separator &amp;&amp; started) {
          started = false;
          client.stop();
        }
      }
    }

    // Luego de recibir la respuesta del servidor podemos decidir cual LED encender
    if (response == &quot;normal&quot;) {
      digitalWrite(LED_GREEN, HIGH);
      digitalWrite(LED_RED, LOW);
    } else if (response == &quot;warning&quot;) {
      digitalWrite(LED_GREEN, LOW);
      digitalWrite(LED_RED, HIGH);
    }

    response = &quot;&quot;; // Limpiamos la variable para la siguiente petición
  } else {
    Serial.print(&quot;connection failed&quot;);
  }

  delay(5000); // Esperamos 5s antes de empezar la siguiente peticion.
}</code></pre>
<p>Este ejemplo tiene un mayor nivel de dificultad ya que debemos realizar la petición HTTP a
bajo nivel aunque en la red existen librerias de terceros que implementan un
cliente HTTP con un API mucho mas sencillo, algunas alternativas son: </p>
<ul>
<li><a href="https://github.com/amcewen/HttpClient">amcewen/HttpClient</a></li>
<li><a href="https://github.com/interactive-matter/HTTPClient">interactive-matter/HTTPClient</a>. </li>
</ul>
<p>Oficialmente solo el <a href="http://arduino.cc/en/Main/ArduinoBoardYun?from=Products.ArduinoYUN">Arduino Yun</a> dentro de sus librerias tiene una clase llamada <a href="http://arduino.cc/en/Reference/YunHttpClientConstructor">HttpClient</a>
que permite realizar peticiones HTTP de una forma mucho mas simple.</p>
<p>Espero que les haya gustado este nuevo artículo, en una próxima ocasión aprenderemos
como realizar esta conexión a través de WebSockets :)</p>
<h3>Más artículos de la serie</h3>
<h4><a href="http://medellinjs.org/posts/introduccion-arduino-nodejs-1">Introducción a Arduino y Node.js - Serial - Parte 1</a></h4>
<h4>Introducción a Arduino y Node.js - WebSockets - Parte 3 (Próximamente)</h4>
<h4>Introducción a Arduino y Node.js - MQTT - Parte 4 (Próximamente)</h4>
<h4>Introducción a Arduino y Node.js - Johnny Five - Parte 5 (Próximamente)</h4>

          </p>
        </div>
      </div>
      <div class="row">
        <div id="disqus_thread"></div>
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'medellinjs'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

      </div>
    </div>
  </div>
</section>


  <div class="footer fullwidth-section">
  <div class="container">
    <div class="row">
      <div class="col-md-12 text-center">
        <h1 class="color-white weight-300 kill-top-margin" style="margin-bottom: 40px; font-size: 50px">
          S&oacute;mos <strong class="color-primary">Medell&iacute;nJS</strong>
        </h1>
        <h4 class="color-white">Hacemos parte de una gran familia, la Comunidad <span class="color-secondary">JavaScript</span> Colombiana</h4>        
      </div>
    </div>
    <div class="row" style="margin-bottom: 10px">
      <div class="col-md-5"></div>
      <div class="col-md-2">
        <img class="img-responsive img-rounded cre-animate" data-animation="slide-in-from-right" data-delay="0" data-easing="easeInOutBack" data-offset="80%" data-speed="1000" src="https://i.imgur.com/azFflhQ.jpg" width="180" />
      </div>
      <div class="col-md-5"></div>
    </div>
    <div class="row">
     <div class="cre-animate" data-animation="slide-up-from-bottom" data-delay="200" data-easing="easeInOutBack" data-offset="80%" data-speed="1000">   
       <div class="col-md-1">
         <span style="font-size: 100px">{</span>
       </div>
       <div class="col-md-2">
        <a href="http://www.bogotajs.com">
          <img class="img-rounded img-responsive" src="http://imgur.com/0VE7Df0.png" width="180" />
          <p class="text-center"><strong>Bogot&aacute;JS</strong></p>
        </a>
       </div>
       <div class="col-md-2">
        <a href="http://www.meetup.com/CaliJS/">
          <img class="img-rounded img-responsive" src="https://i.imgur.com/sBZF10C.png" width="180" />
          <p class="text-center"><strong>CaliJS</strong></p>
        </a>
       </div>
       <div class="col-md-2">
        <a href="http://www.meetup.com/VillavicencioJS/">
          <img class="img-rounded img-responsive" src="https://i.imgur.com/6RKQMj1.png" width="180" />
          <p class="text-center"><strong>VillavicencioJS</strong></p>
        </a>
       </div>
              <div class="col-md-2">
        <a href="https://twitter.com/QuibdoJs">
          <img class="img-rounded img-responsive" src="http://i.imgur.com/MQwQ9Kt.png" width="180" />
          <p class="text-center"><strong>Quibd&oacute;JS</strong></p>
        </a>
       </div>
        <div class="col-md-2">
         <a href="http://www.pereirajs.org">
          <img class="img-rounded img-responsive" src="https://i.imgur.com/K74Qa1f.png" width="180" />
          <p class="text-center"><strong>PereiraJS</strong></p>
        </a>
       </div>
       <div class="col-md-1">
         <span style="font-size: 100px">}</span>
       </div>
     </div>
    </div>
  </div>
</div>
<div class="footer-bottom">
  <div class="row">
    <div class="col-md-6">
      <span class="pull-left" style="font-size: 11px">
        &copy; Copyright 2012-2014 | Medell&iacute;n, Colombia, Sur Am&eacute;rica
      </span>
    </div>
    <div class="col-md-6">
      <span class="pull-right" style="font-size: 11px">
        We are a Passion Driven Community!
      </span>
    </div>
  </div>
</div>


  <script src="/js/jquery-1.11.0.min.js" type="text/javascript"></script>
  <script src="/js/bootstrap.min.js" type="text/javascript"></script>
  <script src="/js/smooth-scroll.js" type="text/javascript"></script>
  <script src="/js/prism.js" type="text/javascript"></script>
  <script src="/js/jquery.cre-animate.min.js" type="text/javascript"></script>    
  <script src="/js/custom.js" type="text/javascript"></script>
  <div class="scrollup">
    <a href="#"><i class="fa fa-chevron-up"></i></a>\
  </div>
</body>

</html>